--DROP TABLE USERS CASCADE CONSTRAINTS;
--DROP TABLE BANKACCOUNTS CASCADE CONSTRAINTS;
--DROP TABLE TRANSACTIONS CASCADE CONSTRAINTS;
--DROP SEQUENCE USER_ID_SEQ;
--DROP SEQUENCE BANK_ACCOUNT_ID_SEQ;

--JDBC BANK ASSIGNMENT

CREATE TABLE USERS (
    USER_ID NUMBER NOT NULL,
    USERNAME VARCHAR2(120) NOT NULL,
    PASSWORD VARCHAR2(120) NOT NULL,
    CONSTRAINT PK_User PRIMARY KEY (USER_ID)
);

CREATE TABLE BANKACCOUNTS(
    BANK_ACCOUNT_ID NUMBER NOT NULL,
    ACCOUNT_TYPE VARCHAR(120) NOT NULL,
    BALANCE NUMBER DEFAULT 0 NOT NULL,
    USER_ID NUMBER NOT NULL,
    CONSTRAINT PK_BankAccount PRIMARY KEY (BANK_ACCOUNT_ID)
);

CREATE TABLE TRANSACTIONS(
    TRANSACTION_TYPE VARCHAR(120) NOT NULL,
    AMOUNT NUMBER NOT NULL,
    USER_ID NUMBER NOT NULL,
    BANK_ACCOUNT_ID NUMBER NOT NULL
);

ALTER TABLE BANKACCOUNTS ADD CONSTRAINT FK_BankAccountUserID
    FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID) ON DELETE CASCADE;

ALTER TABLE TRANSACTIONS ADD CONSTRAINT FK_TransactionUserID
    FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID) ON DELETE CASCADE;

ALTER TABLE TRANSACTIONS ADD CONSTRAINT FK_TransactionBankAccount
    FOREIGN KEY (BANK_ACCOUNT_ID) REFERENCES BANKACCOUNTS(BANK_ACCOUNT_ID) ON DELETE CASCADE;
    
CREATE SEQUENCE USER_ID_SEQ START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE BANK_ACCOUNT_ID_SEQ START WITH 1 INCREMENT BY 1;

create or replace PROCEDURE DELETEBANKACCOUNT(accountID NUMBER, userID NUMBER) AS
acc_balance NUMBER;
BEGIN
    SELECT BALANCE INTO acc_balance FROM BANKACCOUNTS WHERE BANK_ACCOUNT_ID = accountID;
    IF acc_balance = 0 THEN
        DELETE FROM TRANSACTIONS WHERE BANK_ACCOUNT_ID = accountID AND USER_ID = userID;
        DELETE FROM BANKACCOUNTS WHERE BANK_ACCOUNT_ID = accountID;
    END IF;
    dbms_output.put_line('Account ' || accountID || ' deleted');
COMMIT;
END;
/

create or replace PROCEDURE TRUNCATEALLTABLES AS
BEGIN
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TRANSACTIONS CASCADE';
    EXECUTE IMMEDIATE 'TRUNCATE TABLE BANKACCOUNTS CASCADE';
    EXECUTE IMMEDIATE 'TRUNCATE TABLE USERS CASCADE';
COMMIT;
END;
/


